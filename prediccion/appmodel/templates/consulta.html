<!-- templates/consulta.html -->
{% extends 'base.html' %}

{% block title %}Consulta{% endblock %}

{% block content %}

<div class="form-register-container">
    <h2>B√∫squeda de paciente</h2>
    <form action="{% url 'consulta_paciente' %}" method="post" id="form-busqueda">
        {% csrf_token %}
        <div class="form-group">
            <label for="rut">RUT:</label>
            <input type="text" id="rut" name="rut" value="{{ paciente.rut|default_if_none:'' }}" placeholder="Ingrese RUT (ej: 12.345.678-9)" required>
            <div id="rut-error" class="error-message hide"></div>
            <div id="rut-success" class="success-message hide">‚úì RUT encontrado en el sistema</div>
        </div>

        <div class="form-group">
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" name="nombre" value="{{ nombre|default_if_none:'' }}" placeholder="Esperando resultados..." readonly>
        </div>

        <div class="form-group">
            <label for="apellido">Apellido:</label>
            <input type="text" id="apellido" name="apellido" value="{{ apellido|default_if_none:'' }}" placeholder="Esperando resultados..." readonly>
        </div>

        <div class="button-group">
            <button type="submit">Buscar datos</button>
            <button type="button" onclick="limpiarFormulario()">Limpiar datos</button>
        </div>
    </form>
</div>

<div class="form-register-container">
    <h2>Datos paciente</h2>
    <form action="{% url 'evaluacion_riesgo' %}" method="post" id="form-prediccion">
        {% csrf_token %}
        
        <input type="hidden" id="rut_hidden" name="rut" value="{{ paciente.rut|default_if_none:'' }}">

        <div class="form-group">
            <label for="age">Edad:</label>
            <input type="number" id="age" name="age" value="{{ age|default_if_none:'' }}" placeholder="Esperando resultados..." readonly>
        </div>

        <div class="form-group">
            <label for="gender">G√©nero:</label>
            <select id="gender" name="gender" readonly>
                <option value="" disabled selected>Seleccione una opci√≥n</option>
                <option value="1" {% if gender == 1 %} selected {% endif %}>Hombre</option>
                <option value="0" {% if gender == 0 %} selected {% endif %}>Mujer</option>
                <option value="2" {% if gender == 2 %} selected {% endif %}>Otro</option>
            </select>
        </div>

        <div class="form-group">
            <label for="bmi">√çndice de Masa Corporal (BMI):</label>
            <input type="number" step="0.01" id="bmi" name="bmi" value="{{ bmi|default_if_none:'' }}" placeholder="Esperando resultados..." readonly>
        </div>

        <div class="form-group">
            <label for="hypertension">Hipertensi√≥n:</label>
            <select id="hypertension" name="hypertension" readonly>
                <option value="" disabled selected>Seleccione una opci√≥n</option>
                <option value="1" {% if hypertension == 1 %} selected {% endif %}>S√≠</option>
                <option value="0" {% if hypertension == 0 %} selected {% endif %}>No</option>
            </select>
        </div>

        <div class="form-group">
            <label for="heart_disease">Enfermedad Cardiaca:</label>
            <select id="heart_disease" name="heart_disease" readonly>
                <option value="" disabled selected>Seleccione una opci√≥n</option>
                <option value="1" {% if heart_disease == 1 %} selected {% endif %}>S√≠</option>
                <option value="0" {% if heart_disease == 0 %} selected {% endif %}>No</option>
            </select>
        </div>

        <div class="form-group">
            <label for="HbA1c_level">Nivel de HbA1c:</label>
            <input type="number" step="0.01" id="HbA1c_level" name="HbA1c_level" value="{{ hba1c_level|default_if_none:'' }}" placeholder="Esperando resultados..." readonly>
        </div>

        <div class="form-group">
            <label for="blood_glucose_level">Nivel de Glucosa en Sangre:</label>
            <input type="number" step="0.01" id="blood_glucose_level" name="blood_glucose_level" value="{{ blood_glucose_level|default_if_none:'' }}" placeholder="Esperando resultados..." readonly>
        </div>

        <div class="form-group">
            <label for="smoking_history">Historial de Tabaquismo:</label>
            <select id="smoking_history" name="smoking_history" readonly>
                <option value="" disabled selected>Seleccione una opci√≥n</option>
                <option value="0" {% if smoking_history == 0 %} selected {% endif %}>Nunca</option>
                <option value="1" {% if smoking_history == 1 %} selected {% endif %}>Ex-fumador</option>
                <option value="2" {% if smoking_history == 2 %} selected {% endif %}>Fumador ocasional</option>
                <option value="3" {% if smoking_history == 3 %} selected {% endif %}>Fumador habitual</option>
            </select>
        </div>

        <div class="button-group">
            <button type="submit">Predecir</button>
        </div>
    </form>
</div>

<!-- üîπ Resultados completos (modelos + promedio + plan) -->
{% if prediccion_realizada %}
<div class="form-register-container">

    <!-- Panel flotante para alternar visibilidad de algoritmos -->
    <div id="toggle-panel" class="toggle-panel" title="Mostrar / Ocultar algoritmos">
        <label style="cursor:pointer; font-size:13px; display:flex; align-items:center; gap:6px; margin:0;">
            <input type="checkbox" id="toggle-paciente" style="transform:scale(1.1); cursor:pointer;">
            <span>Modo Paciente</span>
        </label>
    </div>

    <div id="algoritmos-container" class="prediccion" style="text-align:center;">
        <h2 style="margin: 20px;">Resultados Predicci√≥n | Algoritmos</h2>

        <!-- üî∏ 1. Modelos individuales -->
        <div class="predicciones-container" style="margin-bottom:30px;">
            <!-- Random Forest -->
            <div class="prediccion">
                <h4>Random Forest</h4>
                <hr style="margin:12px 0;">
                <div class="semaforo-vertical">
                    <div class="circulo {% if rf_prediction <= 30 %}verde{% else %}apagado{% endif %}"></div>
                    <div class="circulo {% if rf_prediction > 30 and rf_prediction <= 60 %}amarillo{% else %}apagado{% endif %}"></div>
                    <div class="circulo {% if rf_prediction > 60 %}rojo{% else %}apagado{% endif %}"></div>
                </div>
                <p><strong>Riesgo Predicho:</strong> {{ rf_prediction|floatformat:2 }}%</p>
                <div class="recomendacion">
                    <h4>Factores Relevantes (RF)</h4>
                    {% if blood_glucose_level > 125 %}<p><strong>Glucosa elevada:</strong> Endocrin√≥logo y monitoreo diario.</p>{% endif %}
                    {% if bmi > 25 %}<p><strong>IMC alto:</strong> Dieta balanceada + actividad f√≠sica.</p>{% endif %}
                </div>
            </div>

            <!-- SVM -->
            <div class="prediccion">
                <h4>Support Vector Machine</h4>
                <hr style="margin:12px 0;">
                <div class="semaforo-vertical">
                    <div class="circulo {% if svm_prediction <= 30 %}verde{% else %}apagado{% endif %}"></div>
                    <div class="circulo {% if svm_prediction > 30 and svm_prediction <= 60 %}amarillo{% else %}apagado{% endif %}"></div>
                    <div class="circulo {% if svm_prediction > 60 %}rojo{% else %}apagado{% endif %}"></div>
                </div>
                <p><strong>Riesgo Predicho:</strong> {{ svm_prediction|floatformat:2 }}%</p>
                <div class="recomendacion">
                    <h4>Factores Relevantes (SVM)</h4>
                    {% if blood_glucose_level > 125 %}<p><strong>Glucosa elevada:</strong> Ajustar carbohidratos y control m√©dico.</p>{% endif %}
                    {% if hypertension %}<p><strong>Hipertensi√≥n:</strong> Reducir sal y controlar presi√≥n.</p>{% endif %}
                </div>
            </div>

            <!-- Regresi√≥n Log√≠stica -->
            <div class="prediccion">
                <h4>Regresi√≥n Log√≠stica</h4>
                <hr style="margin:12px 0;">
                <div class="semaforo-vertical">
                    <div class="circulo {% if logistic_prediction <= 30 %}verde{% else %}apagado{% endif %}"></div>
                    <div class="circulo {% if logistic_prediction > 30 and logistic_prediction <= 60 %}amarillo{% else %}apagado{% endif %}"></div>
                    <div class="circulo {% if logistic_prediction > 60 %}rojo{% else %}apagado{% endif %}"></div>
                </div>
                <p><strong>Riesgo Predicho:</strong> {{ logistic_prediction|floatformat:2 }}%</p>
                <div class="recomendacion">
                    <h4>Factores Relevantes (RL)</h4>
                    {% if smoking_history == '3' or smoking_history == 3 %}<p><strong>Tabaquismo:</strong> Iniciar plan para cesaci√≥n.</p>{% endif %}
                    {% if HbA1c_level > 6.5 %}<p><strong>HbA1c elevada:</strong> Control dietario y terapia m√©dica.</p>{% endif %}
                </div>
            </div>
        </div>
    </div>
        
    <!-- Promedio Predicci√≥n | 3 Modelos -->
    <div class="prediccion" style="text-align:center;">
        <h2 style="margin-top: 10px; text-align:center;">Resultado Predicci√≥n | Paciente</h2>

        <div style="display:flex; flex-wrap:wrap; gap:30px; justify-content:center; align-items:stretch; padding: 20px;">
            <!-- Columna Sem√°foro -->
            <div style="flex:1 1 260px; min-width:240px; display:flex; flex-direction:column; align-items:center; justify-content:center; border:1px solid #ddd; border-radius:10px; padding:20px">
                <div class="semaforo-vertical" style="transform:scale(1.15); margin-bottom:15px;">
                    <div class="circulo {% if promedio_prediccion <= 30 %}verde{% else %}apagado{% endif %}"></div>
                    <div class="circulo {% if promedio_prediccion > 30 and promedio_prediccion <= 60 %}amarillo{% else %}apagado{% endif %}"></div>
                    <div class="circulo {% if promedio_prediccion > 60 %}rojo{% else %}apagado{% endif %}"></div>
                </div>
                <hr style="margin:12px 0;">
                <p style="margin:0; font-size:20px;"><strong>Promedio de Riesgo:</strong> {{ promedio_prediccion|floatformat:2 }}%</p>
            </div>

            <!-- Columna Factores Relevantes Promedio -->
            <div style="flex:1 1 320px; min-width:260px; text-align:left; border:1px solid #ddd; border-radius:10px; padding:20px; background:#ffffff;">
                <h4 style="margin-top:0; text-align:center;">Factores Relevantes</h4>
                <hr style="margin:12px 0;">
                {% if blood_glucose_level > 125 %}<p><strong>Glucosa elevada:</strong> Sostiene aumento global del riesgo.</p>{% endif %}
                {% if HbA1c_level > 6.5 %}<p><strong>HbA1c alta:</strong> Indica control gluc√©mico insuficiente.</p>{% endif %}
                {% if bmi > 25 %}<p><strong>IMC elevado:</strong> Dieta balanceada + actividad f√≠sica.</p>{% endif %}
                {% if hypertension %}<p><strong>Hipertensi√≥n:</strong> Factor cardiovascular que potencia complicaciones.</p>{% endif %}
                {% if smoking_history == '3' or smoking_history == 3 %}<p><strong>Tabaquismo activo:</strong> Incrementa inflamaci√≥n sist√©mica.</p>{% endif %}
                {% if not blood_glucose_level > 125 and not HbA1c_level > 6.5 and not bmi > 25 and not hypertension and smoking_history != '3' and smoking_history != 3 %}
                
                <p>No se identifican factores de alto impacto adicionales sobre el promedio.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ÔøΩ 3. Plan de Recomendaci√≥n -->
    {% if nivel_riesgo_general %}
    <div class="prediccion">
        <h2 style="text-align:center; margin-top: 20px;">üß≠ Plan de Recomendaci√≥n General</h2>
        
        {% if nivel_riesgo_general == "bajo" %}
        <p style="text-align:center; color:green; font-size: 20px;">Riesgo bajo. Mantener estilo de vida saludable.</p>

        {% elif nivel_riesgo_general == "medio" %}
        <p style="text-align:center; color: yellow; font-size: 20px;">Riesgo moderado. Recomendado control preventivo y ajustes.</p>
        
        {% elif nivel_riesgo_general == "alto" %}
        <p style="text-align:center; font-weight:bold; color: red; font-size: 20px;">Riesgo alto. Derivaci√≥n m√©dica prioritaria.</p>
        {% endif %}

        <div style="display:flex; justify-content:space-around; margin-top:25px;">
            <div style="background-color:#e0f7e9; border-radius:10px; padding:18px; width: 450px; text-align:center; margin:10px;">
                <h4 style="margin-top:0;">ü•ó Alimentaci√≥n</h4>
                {% if nivel_riesgo_general == "bajo" %}<p>Mantener dieta rica en vegetales y fibra.</p>
                {% elif nivel_riesgo_general == "medio" %}<p>Reducir az√∫cares y refinados; priorizar frescos.</p>
                {% elif nivel_riesgo_general == "alto" %}<p>Plan nutricional supervisado.</p>{% endif %}
            </div>
            <div style="background-color:#e7f0ff; border-radius:10px; padding:18px; width: 450px; text-align:center; margin:10px;">
                <h4 style="margin-top:0;">üèÉ Actividad F√≠sica</h4>
                {% if nivel_riesgo_general == "bajo" %}<p>Ejercicio moderado 3-5 veces/semana.</p>
                {% elif nivel_riesgo_general == "medio" %}<p>30 min diarios consistentes.</p>
                {% elif nivel_riesgo_general == "alto" %}<p>Evaluaci√≥n m√©dica antes de rutinas.</p>{% endif %}
            </div>
            <div style="background-color:#ffeaea; border-radius:10px; padding:18px; width: 450px; text-align:center; margin:10px;">
                <h4 style="margin-top:0;">ü©∫ Control Cl√≠nico</h4>
                {% if nivel_riesgo_general == "bajo" %}<p>Chequeo anual suficiente.</p>
                {% elif nivel_riesgo_general == "medio" %}<p>Controles cada 3-6 meses.</p>
                {% elif nivel_riesgo_general == "alto" %}<p>Evaluaci√≥n endocrina inmediata.</p>{% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}


<script>
    // Variable para controlar el timeout
    let rutTimeout;

    // Funci√≥n para verificar RUT en tiempo real (para consulta - busca si EXISTE)
    function verificarRUTConsulta() {
        const rut = $('#rut').val().trim();
        
        // Limpiar mensajes previos
        $('#rut-error').removeClass('show').addClass('hide');
        $('#rut-success').removeClass('show').addClass('hide');
        $('#rut').removeClass('input-error input-success');

        if (rut.length >= 8) { // M√≠nimo 8 caracteres para un RUT v√°lido
            // Limpiar timeout anterior
            clearTimeout(rutTimeout);
            
            // Esperar 500ms antes de hacer la consulta
            rutTimeout = setTimeout(function() {
                $.ajax({
                    url: '{% url "verificar_rut" %}',
                    method: 'GET',
                    data: { 'rut': rut },
                    success: function(data) {
                        if (data.existe) {
                            $('#rut-success').removeClass('hide').addClass('show');
                            $('#rut').addClass('input-success');
                        } else {
                            $('#rut-error').text('No existe un paciente registrado con el RUT ' + rut).removeClass('hide').addClass('show');
                            $('#rut').addClass('input-error');
                        }
                    },
                    error: function() {
                        console.log('Error al verificar RUT');
                    }
                });
            }, 500);
        }
    }

    // Document ready
    $(document).ready(function() {
        // Agregar validaci√≥n en tiempo real al campo RUT
        $('#rut').on('input', verificarRUTConsulta);
        
        // Validar antes de enviar el formulario
        $('#form-busqueda').on('submit', function(e) {
            const rutError = $('#rut-error').hasClass('show');
            
            // Si hay error de RUT (no existe), prevenir el env√≠o
            if (rutError) {
                e.preventDefault();
                alert('No se puede buscar: No existe un paciente con este RUT en el sistema.');
                return false;
            }
        });
    });

    function limpiarFormulario() {
        // Limpiar datos de b√∫squeda
        document.getElementById('rut').value = '';
        document.getElementById('nombre').value = '';
        document.getElementById('apellido').value = '';

        // Limpiar datos del paciente
        document.getElementById('rut_hidden').value = '';
        document.getElementById('age').value = '';
        document.getElementById('gender').selectedIndex = 0;
        document.getElementById('bmi').value = '';
        document.getElementById('hypertension').selectedIndex = 0;
        document.getElementById('heart_disease').selectedIndex = 0;
        document.getElementById('HbA1c_level').value = '';
        document.getElementById('blood_glucose_level').value = '';
        document.getElementById('smoking_history').selectedIndex = 0;

        // Limpiar mensajes de validaci√≥n
        $('#rut-error').removeClass('show').addClass('hide');
        $('#rut-success').removeClass('show').addClass('hide');
        $('#rut').removeClass('input-error input-success');

        // Recargar la p√°gina para eliminar los resultados de predicci√≥n
        window.location.href = window.location.pathname;
    }
</script>

<style>
    .input-error {
        border: 2px solid #dc3545 !important;
        background-color: #fff5f5 !important;
    }
    
    .input-success {
        border: 2px solid #28a745 !important;
        background-color: #f5fff5 !important;
    }
    
    .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        margin-top: 5px;
    }
    
    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        margin-top: 5px;
    }
    
    .show {
        display: block !important;
    }
    
    .hide {
        display: none !important;
    }

    .toggle-panel {
        position: fixed;
        bottom: 22px;
        right: 22px;
        background: linear-gradient(135deg, #ffffff 0%, #f2f6fa 100%);
        box-shadow: 0 6px 18px rgba(0,0,0,0.18);
        padding: 12px 16px;
        border-radius: 14px;
        z-index: 999;
        border: 1px solid #d4dce3;
        backdrop-filter: blur(6px);
        transition: box-shadow .25s, transform .25s;
    }
    .toggle-panel:hover { box-shadow: 0 8px 22px rgba(0,0,0,0.28); transform: translateY(-2px); }
    .toggle-panel input[type="checkbox"]:checked + span {
        font-weight: 600;
        color: #0a5fb4;
    }
    @media (max-width: 768px) {
    .toggle-panel { bottom: 15px; right: 12px; padding: 10px 12px; }
    }
</style>

<script>
    (function(){
        // Ejecutar al cargar
        const chk = document.getElementById('toggle-paciente');
        const contAlg = document.getElementById('algoritmos-container');
        if(!chk || !contAlg) return;
        const key = 'modoPacienteOcultaAlgoritmos';
        const saved = localStorage.getItem(key);
        if(saved === '1') {
            chk.checked = true;
            contAlg.style.display = 'none';
        }
        chk.addEventListener('change', () => {
            if(chk.checked){
                contAlg.style.display = 'none';
                localStorage.setItem(key,'1');
            } else {
                contAlg.style.display = '';
                localStorage.setItem(key,'0');
            }
        });
    })();
</script>

{% endblock %}
