{% extends 'base.html' %}
{% load static %}

{% block title %}Listado de Pacientes{% endblock %}

{% block content %}
<div class="form-register-container">

    <div style="margin-bottom:25px; padding:18px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.06);">
        <h2 style="margin-top:0;">Buscar Pacientes</h2>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <input type="text" id="buscador" placeholder="Nombre, Apellido o RUT" style="flex:1; padding:10px 14px; border:1px solid #cfd8e3; border-radius:8px; font-size:15px;">
            <button type="button" id="limpiar" style="padding:10px 18px; border:none; background:#0066cc; color:#fff; border-radius:8px; cursor:pointer;">Limpiar</button>
        </div>
        <small style="display:block; margin-top:8px; color:#555;">Haga ingreso de datos para realizar la búsqueda.</small>
        <div id="resultados-busqueda" style="margin-top:18px; display:none; border:1px solid #dbe3ec; border-radius:10px; background:#fff; max-height:360px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#e9f1f9;">
                        <th style="padding:10px;">RUT</th>
                        <th style="padding:10px;">Nombre</th>
                        <th style="padding:10px;">Edad</th>
                        <th style="padding:10px;"> </th>
                    </tr>
                </thead>
                <tbody id="lista-resultados"></tbody>
            </table>
        </div>
    </div>

    <div id="detallePopup" class="popup" style="display:none;">
        <div class="popup-content" style="max-width:720px; width:90%; position:relative; display:flex; flex-direction:column; align-items:center;">
            <button type="button" class="close" onclick="cerrarDetalle()" aria-label="Cerrar" style="position:absolute; top:10px; right:14px; font-size:22px; cursor:pointer; background:transparent; border:none;">&times;</button>
            <h2 style="margin:0 0 14px; text-align:center;">Ficha Paciente</h2>
                <form id="form-edicion-paciente" onsubmit="return false;">
                        <input type="hidden" id="paciente-id-hidden" value="">
                        <table id="tabla-detalle" class="ficha-table" aria-describedby="titulo-ficha">
                            <thead>
                                <tr class="ficha-head">
                                    <th scope="col" style="text-align:right; width:40%;">Campo</th>
                                    <th scope="col" style="text-align:left;">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-detalle-body"><!-- filas dinámicas --></tbody>
                        </table>
                </form>
            <div id="acciones-view" style="display:flex; gap:10px; justify-content:center; margin-top:18px;">
                    <button type="button" class="btn-primario" onclick="entrarEdicion()">Editar</button>
                    <button type="button" class="btn-info" onclick="descargarPDFActual()">Descargar</button>
                    <form id="form-eliminar-paciente" method="post" style="display:inline;" onsubmit="return confirmarEliminar();">
                        {% csrf_token %}
                        <button type="submit" class="btn-secundario" style="background:#d93025; border:none;" title="Eliminar paciente">Eliminar</button>
                    </form>
                    <button type="button" class="btn-outline" onclick="cerrarDetalle()">Cerrar</button>
            </div>
            <div id="acciones-edit" style="display:none; gap:10px; justify-content:center; margin-top:18px;">
                    <button type="button" class="btn-primario" onclick="guardarEdicion()">Guardar</button>
                    <button type="button" class="btn-secundario" onclick="cancelarEdicion()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
    const inputBuscador = document.getElementById('buscador');
    const contResultados = document.getElementById('resultados-busqueda');
    const cuerpoResultados = document.getElementById('lista-resultados');
    const btnLimpiar = document.getElementById('limpiar');
    let abortCtrl = null;

    function templateFila(r){
        return `<tr style="border-bottom:1px solid #eef;">
            <td style="padding:8px 10px;">${r.rut}</td>
            <td style="padding:8px 10px;">${r.nombre} ${r.apellido}</td>
            <td style="padding:8px 10px;">${r.edad}</td>
            <td style="padding:8px 10px; text-align:center;"><button class="btn-detalle" data-id="${r.id}" style="padding:4px 10px; background:#0a6dd9; color:#fff; border:none; border-radius:5px; cursor:pointer; font-size:13px;">Ver</button></td>
        </tr>`;
    }

    async function buscar(q){
        if(abortCtrl){abortCtrl.abort();}
        if(!q){cuerpoResultados.innerHTML=''; contResultados.style.display='none'; return;}
        abortCtrl = new AbortController();
        try{
            const resp = await fetch(`{% url 'buscar_pacientes' %}?q=${encodeURIComponent(q)}`, {signal:abortCtrl.signal});
            if(!resp.ok) return;
            const data = await resp.json();
            const res = data.resultados || [];
            if(res.length===0){cuerpoResultados.innerHTML='<tr><td colspan="4" style="padding:10px; text-align:center; color:#666;">Sin coincidencias</td></tr>';}
            else{cuerpoResultados.innerHTML = res.map(r=>templateFila(r)).join('');}
            contResultados.style.display='block';
        }catch(e){ if(e.name!=='AbortError'){ console.error(e); } }
    }

    inputBuscador.addEventListener('input', e=>{ buscar(e.target.value.trim()); });
    btnLimpiar.addEventListener('click', ()=>{ inputBuscador.value=''; buscar(''); });

    document.addEventListener('click', e=>{
        if(e.target.classList.contains('btn-detalle')){
            const id = e.target.getAttribute('data-id');
            mostrarDetalle(id);
        }
    });

    async function mostrarDetalle(id){
        try {
            const resp = await fetch(`{% url 'buscar_pacientes' %}?id=${encodeURIComponent(id)}`);
            const data = await resp.json();
            const encontrado = (data.resultados||[])[0];
        // Guardar id
        document.getElementById('paciente-id-hidden').value = encontrado.id;
        // Actualizar action del formulario de eliminación
        const formEliminar = document.getElementById('form-eliminar-paciente');
        if(formEliminar){
            formEliminar.action = `{% url 'eliminar_paciente' 0 %}`.replace('0', encontrado.id);
        }
            if(!encontrado){return;}
        // Resetear flag de edición al abrir nuevo detalle (solo si no es una actualización después de guardar)
        datosEditados = false;
        await mostrarDetalleSinReset(id, encontrado);
        } catch(err){ console.error(err); }
    }

    async function mostrarDetalleSinReset(id, datosEncontrado = null){
        try {
            let encontrado = datosEncontrado;
            if(!encontrado) {
                const resp = await fetch(`{% url 'buscar_pacientes' %}?id=${encodeURIComponent(id)}`);
                const data = await resp.json();
                encontrado = (data.resultados||[])[0];
                document.getElementById('paciente-id-hidden').value = encontrado.id;
            }
            if(!encontrado){return;}
        const filas = [
                ['RUT', encontrado.rut],
                ['Nombre', encontrado.nombre],
                ['Apellido', encontrado.apellido],
                ['Edad', encontrado.edad],
                ['Nacimiento', encontrado.nacimiento],
                ['Género', encontrado.genero],
                ['IMC', encontrado.bmi],
                ['Hipertensión', encontrado.hipertension],
                ['Cardiopatía', encontrado.enfermedad_cardiaca],
                ['HbA1c', encontrado.nivel_hba1c],
                ['Glucosa', encontrado.nivel_glucosa],
                ['Tabaquismo', encontrado.historial_tabaquismo],
                ['Observaciones', encontrado.observaciones || '—']
        ];
        const filasHtml = filas.map(par => `<tr data-campo="${par[0]}"><th class="ficha-label">${par[0]}</th><td class="celda-valor ficha-value" data-key="${normalizarClave(par[0])}">${escapeHtml(par[1])}</td></tr>`).join('');
        document.getElementById('tabla-detalle-body').innerHTML = filasHtml;
        modoVista();
            document.getElementById('detallePopup').style.display='flex';
        } catch(err){ console.error(err); }
    }

    let datosEditados = false; // Flag para saber si se editaron datos

    function cerrarDetalle(){
        document.getElementById('detallePopup').style.display='none';
        // Si se editaron datos, actualizar la búsqueda actual
        console.log('Cerrando popup, datosEditados:', datosEditados, 'búsqueda actual:', inputBuscador.value.trim());
        if(datosEditados && inputBuscador.value.trim()){
            console.log('Actualizando búsqueda...');
            buscar(inputBuscador.value.trim());
            datosEditados = false;
        }
    }

    function normalizarClave(label){
        return label.toLowerCase().replace(/á/g,'a').replace(/é/g,'e').replace(/í/g,'i').replace(/ó/g,'o').replace(/ú/g,'u').replace(/[^a-z0-9]+/g,'_').replace(/_+/g,'_').replace(/(^_|_$)/g,'');
    }
    function escapeHtml(v){return String(v).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));}

    let backupValores = {};
    function entrarEdicion(){
        backupValores={};
        document.querySelectorAll('#tabla-detalle-body td.celda-valor').forEach(td=>{
            const key = td.dataset.key;
            const val = td.textContent.trim();
            backupValores[key]=val;
            td.innerHTML = generarInputPara(key,val);
        });
        modoEdicion();
    }
    function generarInputPara(key,val){
        const mapSelect = {
            genero:[['Hombre',1],['Mujer',0],['Otro',2]],
            hipertension:[['Sí',1],['No',0]],
            cardiopatia:[['Sí',1],['No',0]],
            tabaquismo:[['Nunca',0],['Ex-fumador',1],['Fumador ocasional',2],['Fumador habitual',3]]
        };
        if(key==='nacimiento') return `<input class="ficha-input" type="date" name="nacimiento" value="${formatearFechaInput(val)}">`;
        if(key==='edad') return `<input class="ficha-input" type="number" min="0" name="edad" value="${val}">`;
        if(key==='imc') return `<input class="ficha-input" type="number" step="0.1" name="bmi" value="${val}">`;
        if(key==='hba1c') return `<input class="ficha-input" type="number" step="0.1" name="nivel_hba1c" value="${val}">`;
        if(key==='glucosa') return `<input class="ficha-input" type="number" step="0.1" name="nivel_glucosa" value="${val}">`;
        if(key==='observaciones') return `<textarea class="ficha-input" name="observaciones" rows="2">${val==='—'?'':val}</textarea>`;
        if(mapSelect[key]){
            const opts = mapSelect[key].map(([txt,v])=>`<option value="${v}" ${String(val).startsWith(txt)?'selected':''}>${txt}</option>`).join('');
            const nameMap={genero:'genero',hipertension:'hipertension',cardiopatia:'enfermedad_cardiaca',tabaquismo:'historial_tabaquismo'};
            return `<select class="ficha-input" name="${nameMap[key]}">${opts}</select>`;
        }
        if(key==='rut' || key==='nombre' || key==='apellido') return `<input class="ficha-input" type="text" name="${key}" value="${val}">`;
        return `<input class="ficha-input" type="text" name="${key}" value="${val}">`;
    }
    function formatearFechaInput(v){
        if(!v) return '';
        const partes=v.split('-');
        if(partes[0].length===2) return `${partes[2]}-${partes[1]}-${partes[0]}`;
        return v;}

    function cancelarEdicion(){
        document.querySelectorAll('#tabla-detalle-body td.celda-valor').forEach(td=>{
            const key=td.dataset.key; td.textContent=backupValores[key]??'';
        });
        modoVista();
    }
    async function guardarEdicion(){
        const id=document.getElementById('paciente-id-hidden').value;
        const formData=new FormData();
        document.querySelectorAll('#tabla-detalle-body td.celda-valor').forEach(td=>{
            const input=td.querySelector('input,select,textarea');
            if(input){
                // Solo enviar datos de los inputs cuando están en modo edición
                formData.append(input.name, input.value.trim());
            }
        });
        try{
            const resp= await fetch(`/editar_paciente_json/${id}/`,{method:'POST', headers:{'X-CSRFToken':obtenerCSRF()}, body:formData});
            const data= await resp.json();
            if(!data.ok){alert(data.error||'Error al guardar'); return;}
            // Marcar que se editaron datos para actualizar búsqueda al cerrar
            console.log('Datos guardados exitosamente, marcando datosEditados como true');
            // Refrescar detalle con valores guardados (sin resetear flag)
            await mostrarDetalleSinReset(id);
            datosEditados = true; // Marcar después de mostrar detalle
        }catch(e){console.error(e); alert('Error de red.');}
    }
    function obtenerCSRF(){
        const name='csrftoken';
        const cookies=document.cookie.split(';');
        for(const c of cookies){const kv=c.trim().split('='); if(kv[0]===name) return decodeURIComponent(kv[1]);}
        return '';
    }
    function modoEdicion(){
        document.getElementById('acciones-view').style.display='none';
        document.getElementById('acciones-edit').style.display='flex';
    }
    function modoVista(){
        document.getElementById('acciones-view').style.display='flex';
        document.getElementById('acciones-edit').style.display='none';
    }
    function descargarPDFActual(){
        const id=document.getElementById('paciente-id-hidden').value;
        if(!id) return;
        window.open(`/reporte_paciente/${id}/`,'_blank');
    }
    function abrirEnvioCorreo(){
        const id=document.getElementById('paciente-id-hidden').value; 
        if(!id) return;
        // Reutilizar popup correo original si existe
        openEmailPopup(id);
    }
    function confirmarEliminar(){
        if(!confirm('¿Seguro que desea eliminar este paciente? Esta acción no se puede deshacer.')) return false;
        // Interceptar envío para hacerlo vía fetch
        const form = document.getElementById('form-eliminar-paciente');
        const id = document.getElementById('paciente-id-hidden').value;
        if(!id) return false;
        const action = form.action;
        const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
        fetch(action, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrf, 'X-Requested-With': 'XMLHttpRequest', 'Accept':'application/json' },
        }).then(r=>r.json()).then(data=>{
            if(data.ok){
                mostrarToast('Paciente eliminado');
                cerrarDetalle();
                // Re-ejecutar búsqueda actual sin perder término
                const q = inputBuscador.value.trim();
                if(q){ buscar(q); }
            } else {
                mostrarToast(data.error || 'Error al eliminar','error');
            }
        }).catch(()=> mostrarToast('Error de red','error'));
        return false; // Prevenir envío normal
    }
    // Toast simple reutilizable
    function mostrarToast(msg, tipo='ok'){
        let el = document.getElementById('toast-notify');
        if(!el){
            el = document.createElement('div');
            el.id='toast-notify';
            el.style.cssText='position:fixed; top:20px; right:20px; background:#2563eb; color:#fff; padding:12px 18px; border-radius:8px; font-size:14px; box-shadow:0 4px 14px rgba(0,0,0,.25); z-index:2000; opacity:0; transition:opacity .25s;';
            document.body.appendChild(el);
        }
        el.style.background = tipo==='error' ? '#dc2626' : '#2563eb';
        el.textContent = msg;
        requestAnimationFrame(()=>{ el.style.opacity=1; });
        clearTimeout(el._t);
        el._t = setTimeout(()=>{ el.style.opacity=0; }, 3000);
    }
    </script>

    <style>
        #resultados-busqueda table th, #resultados-busqueda table td { font-size:13px; }
        #detallePopup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; }
        #detallePopup .popup-content { background:#fff; border-radius:12px; padding:22px 26px; box-shadow:0 10px 28px rgba(0,0,0,.25); animation:fadeIn .25s ease; }
        @keyframes fadeIn { from {opacity:0; transform:scale(.96);} to {opacity:1; transform:scale(1);} }
    </style>

</div>

<div id="emailPopup" class="popup" style="display:none;">
    <div class="popup-content">
    <button type="button" class="close" onclick="closePopup()" aria-label="Cerrar" style="background:transparent; border:none;">&times;</button>
        <form id="emailForm" method="post" action="">
            {% csrf_token %}
            <div class="form-group">
                <label for="email">Correo Electrónico:</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <button type="button" class="send-button" onclick="submitEmailForm()">Enviar Reporte</button>
            </div>
        </form>
    </div>
</div>

<script>
    let pacienteId = null;

    function openEmailPopup(id) {
        pacienteId = id;
        document.getElementById("emailPopup").style.display = "flex";
    }

    function closePopup() {
        document.getElementById("emailPopup").style.display = "none";
    }

    function submitEmailForm() {
        const email = document.getElementById("email").value;
        if (email && pacienteId) {
            const form = document.getElementById("emailForm");
            form.action = `{% url 'enviar_reporte' 0 %}`.replace('0', pacienteId);
            form.submit();
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const popup = document.getElementById("emailPopup");
        window.addEventListener("click", (event) => {
            if (event.target === popup) {
                closePopup();
            }
        });
    });

    function setupEditButtons() {
        const editButtons = document.querySelectorAll("[id^=edit-button]");
        editButtons.forEach(button => {
            button.addEventListener("click", () => {
                const id = button.id.replace("edit-button-", "");
                toggleEdit(id);
            });
        });
    }

    function toggleEdit(id) {
        const fields = ["rut", "nombre", "apellido", "edad", "nacimiento", "genero", "bmi", "hipertension", "cardiopatia", "hba1c", "glucosa", "tabaquismo", "observaciones"];
        fields.forEach(field => {
            const span = document.getElementById(`${field}-${id}`);
            const input = document.getElementById(`input-${field}-${id}`);
            if (span.style.display === "none") {
                span.style.display = "";
                input.style.display = "none";
            } else {
                span.style.display = "none";
                input.style.display = "";
            }
        });
        const button = document.getElementById(`edit-button-${id}`);
        const saveButton = document.getElementById(`save-button-${id}`);
        const downloadButton = document.getElementById(`download-button-${id}`);
        const shareButton = document.getElementById(`share-button-${id}`);
        button.style.display = button.style.display === "none" ? "" : "none";
        saveButton.style.display = saveButton.style.display === "none" ? "" : "none";
        downloadButton.style.display = downloadButton.style.display === "none" ? "" : "none";
        shareButton.style.display = shareButton.style.display === "none" ? "" : "none";

    }

    document.addEventListener("DOMContentLoaded", setupEditButtons);
</script>

<style>
    .table-wrapper {
        max-width: 100%;
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    table th, table td {
        padding: 8px;
        text-align: center;
    }
    .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }
    /* Popup principal detalle */
    #detallePopup {
        z-index: 1000;
    }
    #detallePopup .popup-content {
        width: 760px;
        max-width: 90vw;
        padding: 34px 46px 26px;
    }
    #detallePopup h3 { margin-top:4px; }
    #detallePopup #tabla-detalle { margin-top:6px; }
    /* Popup email (debe aparecer por encima del popup principal) */
    #emailPopup {
        z-index: 1100;
    }
    #emailPopup .popup-content {
        background-color: #fff;
        padding: 30px;
        border-radius: 5px;
        width: 400px;
        box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.3);
        position: relative;
        text-align: center;
    }
    .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 20px;
        cursor: pointer;
    }
    .form-group {
        margin-bottom: 20px; /* Espaciado entre el correo y el input */
    }
    label {
        display: block;
        margin-bottom: 8px; /* Espaciado entre el label y el input */
    }
    input[type="email"] {
        width: 100%; /* Hacer el input un poco más pequeño para centrarlo */
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
        text-align: center;
    }
    .send-button {
        background-color: #0066cc; /* Color azul para el botón */
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .send-button:hover {
        background-color: #0b7dda;
    }
    /* Estilos ficha paciente */
    .ficha-table { border-collapse:collapse; font-size:14px; margin:4px auto 10px; width:98%; min-width:600px; line-height:1.2; }
    .ficha-head { background:#e2e8f0; font-weight:600; font-size:13.5px; }
    .ficha-col-label { text-align:right; padding:6px 16px; width:38%; }
    .ficha-col-value { text-align:left; padding:6px 16px; }
    .ficha-label { background:#f1f5f9; text-align:right; padding:6px 16px; font-weight:600; white-space:nowrap; }
    .ficha-value { padding:6px 16px; min-width:240px; vertical-align:middle; }
    #detallePopup .ficha-input { width:100%; box-sizing:border-box; padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; font-size:13px; margin:0; }
    #detallePopup .ficha-input:focus { outline:2px solid #2563eb; border-color:#2563eb; }
    #detallePopup .ficha-table tr { line-height:1.2; }
    #detallePopup .ficha-table td, #detallePopup .ficha-table th { vertical-align:middle; padding:6px 16px; }
    #detallePopup .ficha-label { background:#f1f5f9; text-align:right; font-weight:600; white-space:nowrap; }
    #detallePopup .ficha-value { min-width:240px; text-align:left; }
    #acciones-view button, #acciones-edit button { min-width:92px; }
</style>

{% endblock %}
